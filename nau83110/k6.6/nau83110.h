/* SPDX-License-Identifier: GPL-2.0-only */
/*
 * The NAU83110 ALSA SoC audio driver. The codec is a mono high efficiency
 * filter-free Class-D audio amplifier, which is capable of driving a 4Î© load
 * with up to 20.8W output power at 12.6V supply.
 *
 * Copyright (C) 2025 Nuvoton Technology Corp.
 * Author: Neo Chang <ylchang2@nuvoton.com>
 */

#ifndef __NAU83110_H__
#define __NAU83110_H__

#define NAU83110_R00_SW_RST_EN			0x00 
#define NAU83110_R01_AUDIO_RST_EN		0x01
#define NAU83110_R02_I2C_ADDRESS_LATCH		0x02
#define NAU83110_R16_INTR_CTRL0			0x16
#define NAU83110_R17_INTR_CTRL1			0x17
#define NAU83110_R18_INTR_CTRL2			0x18
#define NAU83110_R19_INTR_CTRL3			0x19
#define NAU83110_R1B_INTR_CTRL4			0x1B
#define NAU83110_R58_DAC_VOLUME_CTRL		0x58
#define NAU83110_R59_ALC_MODE_CTRL		0x59
#define NAU83110_R5A_ALCDCY_CLIP		0x5A
#define NAU83110_R5B_ALCATK_CLIP		0x5B
#define NAU83110_R5C_ALCHLD_CLIP		0x5C
#define NAU83110_R5D_ALC_MINGAIN_CLIP		0x5D
#define NAU83110_R5F_ALCATK_OTW2		0x5F
#define NAU83110_R60_ALCHLD_OTW2		0x60
#define NAU83110_R61_ALC_MINGAIN_OTW2		0x61
#define NAU83110_R63_ALCATK_OTW1		0x63
#define NAU83110_R64_ALCHLD_OTW1		0x64
#define NAU83110_R65_ALC_MINGAIN_OTW1		0x65
#define NAU83110_R67_ALCATK_UVLOP		0x67
#define NAU83110_R68_ALCHLD_UVLOP		0x68
#define NAU83110_R69_ALC_MINGAIN_STEP_UVLOP	0x69
#define NAU83110_R6D_DIAG_CTRL0			0x6D
#define NAU83110_R6E_DIAG_CTRL1			0x6E
#define NAU83110_R6F_DIAG_CTRL2			0x6F
#define NAU83110_R74_CLIP_CTRL			0x74
#define NAU83110_R76_DAC_CTRL1			0x76
#define NAU83110_R77_HPF_CTRL			0x77
#define NAU83110_R78_I2S_PCM_CTRL2		0x78
#define NAU83110_R7A_MUTE_CTRL			0x7A
#define NAU83110_R7B_MUTE_RAMP_SPD		0x7B
#define NAU83110_R7C_TDM_RX_CTRL0		0x7C
#define NAU83110_R7D_TDM_RX_CTRL1		0x7D
#define NAU83110_R80_TDM_TX_CTRL0		0x80
#define NAU83110_R81_TDM_TX_CTRL1		0x81
#define NAU83110_RA8_STANDBY_CTRL		0xA8
#define NAU83110_RB6_ANALOG_CTRL0		0xB6
#define NAU83110_RB7_ANALOG_CTRL1		0xB7
#define NAU83110_RB9_ANALOG_READ0		0xB9
#define NAU83110_RBA_ANALOG_READ1		0xBA
#define NAU83110_RBB_PWRSTAGE_CTRL0		0xBB
#define NAU83110_RBC_PWRSTAGE_CTRL1		0xBC
#define NAU83110_RBD_PWRSTAGE_CTRL2		0xBD
#define NAU83110_RF0_DEV_INFO0			0xF0
#define NAU83110_RF1_DEV_INFO1			0xF1
#define NAU83110_REG_MAX			NAU83110_RF1_DEV_INFO1

/* 16-bit control register address, and 16-bits control register data */
#define NAU83110_REG_ADDR_LEN		16
#define NAU83110_REG_DATA_LEN		16

/* NAU83110_R16_INTR_CTRL0 (0x16) */
#define NAU83110_INT_POLAR 		(1 << 15)

/* NAU83110_R17_INTR_CTRL1 (0x17) */
#define NAU83110_INT_BCLKDET_EN		(1 << 15)
#define NAU83110_INT_TALARM_EN		(1 << 14)
#define NAU83110_INT_OWT2_EN		(1 << 13)
#define NAU83110_INT_OWT1_EN		(1 << 12)
#define NAU83110_INT_SCP_EN		(1 << 11)
#define NAU83110_INT_DIAGCMPVDDP_EN	(1 << 10)
#define NAU83110_INT_DIAGCMPVDDN_EN	(1 << 9)
#define NAU83110_INT_DIAGCMPVSSP_EN	(1 << 8)
#define NAU83110_INT_DIAGCMPVSSN_EN	(1 << 7)
#define NAU83110_INT_DIAGCMPSPKO_EN	(1 << 6)
#define NAU83110_INT_DIAGCMPSPKS_EN	(1 << 5)
#define NAU83110_INT_UVLOP_EN		(1 << 4)
#define NAU83110_INT_OVLOB_EN		(1 << 3)
#define NAU83110_INT_DIANDONE_EN	(1 << 2)
#define NAU83110_INT_SOFTMUTEDN_EN	(1 << 1)
#define NAU83110_INT_PROT_EN \
	(NAU83110_INT_TALARM_EN | \
	NAU83110_INT_OWT2_EN | \
	NAU83110_INT_OWT1_EN | \
	NAU83110_INT_SCP_EN )

/* NAU83110_R18_INTR_CTRL2 (0x18) */
#define NAU83110_INT_BCLKDET_MASK	(1 << 15)
#define NAU83110_INT_TALARM_MASK	(1 << 14)
#define NAU83110_INT_OWT2_MASK		(1 << 13)
#define NAU83110_INT_OWT1_MASK		(1 << 12)
#define NAU83110_INT_SCP_MASK		(1 << 11)
#define NAU83110_INT_DIAGCMPVDDP_MASK	(1 << 10)
#define NAU83110_INT_DIAGCMPVDDN_MASK	(1 << 9)
#define NAU83110_INT_DIAGCMPVSSP_MASK	(1 << 8)
#define NAU83110_INT_DIAGCMPVSSN_MASK	(1 << 7)
#define NAU83110_INT_DIAGCMPSPKO_MASK	(1 << 6)
#define NAU83110_INT_DIAGCMPSPKS_MASK	(1 << 5)
#define NAU83110_INT_UVLOP_MASK		(1 << 4)
#define NAU83110_INT_OVLOB_MASK		(1 << 3)
#define NAU83110_INT_DIANDONE_MASK	(1 << 2)
#define NAU83110_INT_SOFTMUTEDN_MASK	(1 << 1)
#define NAU83110_COMMON_INT_MASK \
	(NAU83110_INT_BCLKDET_MASK | \
	NAU83110_INT_TALARM_MASK | \
	NAU83110_INT_OWT2_MASK | \
	NAU83110_INT_OWT1_MASK | \
	NAU83110_INT_SCP_MASK | \
	NAU83110_INT_UVLOP_MASK | \
	NAU83110_INT_OVLOB_MASK)

/* NAU83110_R19_INTR_CTRL3 (0x19) */
#define NAU83110_INT_BCLKDETB		(1 << 15)
#define NAU83110_INT_TALARM		(1 << 14)
#define NAU83110_INT_OWT2		(1 << 13)
#define NAU83110_INT_OWT1		(1 << 12)
#define NAU83110_INT_SCP		(1 << 11)
#define NAU83110_INT_DIAGCMPVDDP	(1 << 10)
#define NAU83110_INT_DIAGCMPVDDN	(1 << 9)
#define NAU83110_INT_DIAGCMPVSSP	(1 << 8)
#define NAU83110_INT_DIAGCMPVSSN	(1 << 7)
#define NAU83110_INT_DIAGCMPSPKO	(1 << 6)
#define NAU83110_INT_DIAGCMPSPKS	(1 << 5)
#define NAU83110_INT_UVLOP		(1 << 4)
#define NAU83110_INT_OVLOB		(1 << 3)
#define NAU83110_INT_DIANDONE		(1 << 2)
#define NAU83110_INT_SOFTMUTEDN		(1 << 1)
#define NAU83110_INT_PWMMIS		(1 << 0)
#define NAU83110_INT_DIAG ( \
	NAU83110_INT_DIAGCMPVDDP | \
	NAU83110_INT_DIAGCMPVDDN | \
	NAU83110_INT_DIAGCMPVSSP | \
	NAU83110_INT_DIAGCMPVSSN | \
	NAU83110_INT_DIAGCMPSPKO | \
	NAU83110_INT_DIAGCMPSPKS)

/* BCLK_STATUS (0x1B) */
#define NAU83110_BCLK_STATUS_SFT	15
#define NAU83110_BCLK_NO_BCLK		(0x1 << NAU83110_BCLK_STATUS_SFT)

/* NAU83110_R58_DAC_VOLUME_CTRL (0x58) */
#define NAU83110_DAC_VOL_MAX		0xff

/* NAU83110_R59_ALC_MODE_CTRL (0x59) */
#define NAU83110_ALCZC_SFT		14
#define NAU83110_SLOWCLKEN_SFT		13
#define NAU83110_ALCEN_SFT		12
#define NAU83110_ENAUTOATT_SFT		5
#define NAU83110_ENAUTOATT		(0x1 << NAU83110_ENAUTOATT_SFT)

/* NAU83110_R6D_DIAG_CTRL0 (0x6D) */
#define NAU83110_DIAG_EN_SFT		15
#define NAU83110_DIAG_EN		(0x1 << NAU83110_DIAG_EN_SFT)

/* NAU83110_R74_CLIP_CTRL (0x74) */
#define NAU83110_CLIP_EN_SFT		4
#define NAU83110_CLIP_EN		(0x1 << NAU83110_CLIP_EN_SFT)

/* NAU83110_R76_DAC_CTRL1 (0x76) */
#define NAU83110_DACDEM_SFT		15
#define NAU83110_DACDEM_ON		(0x1 << NAU83110_DACDEM_SFT)
#define NAU83110_DACDEMDELAY_SFT	14
#define NAU83110_DACDEMDELAY_ON		(0x1 << NAU83110_DACDEMDELAY_SFT)
#define NAU83110_OVSRATE_MASK		GENMASK(2, 0)
#define NAU83110_OVSRATE_32		0x4
#define NAU83110_OVSRATE_128		0x2
#define NAU83110_OVSRATE_64		0x0

/* NAU83110_R77_HPF_CTRL (0x77) */
#define NAU83110_HPF_EN_SFT		15
#define NAU83110_HPF_APP_SFT		14

/* NAU83110_R78_I2S_PCM_CTRL2 (0x78) */
#define NAU83110_PCM_TS_EN_SFT		10
#define NAU83110_PCM_TS_EN		(0x1 << NAU83110_PCM_TS_EN_SFT)

/* NAU83110_R7A_MUTE_CTRL (0x7A) */
#define NAU83110_SOFT_MUTE_SFT		15
#define NAU83110_SOFT_MUTE		(0x1 << NAU83110_SOFT_MUTE_SFT)
#define NAU83110_DACZCEN_SFT		8
#define NAU83110_DACZCEN		(0x1 << NAU83110_DACZCEN_SFT)
#define NAU83110_UNMUTECTL_SFT		6
#define NAU83110_UNMUTECTL		(0x1 << NAU83110_UNMUTECTL_SFT)
#define NAU83110_ANAMUTE_SFT		4
#define NAU83110_ANAMUTE		(0x3 << NAU83110_ANAMUTE_SFT)

/* NAU83110_R7C_TDM_RX_CTRL0 (0x7C) */
#define NAU83110_RCHA_SFT		9
#define NAU83110_RCHA_MASK		GENMASK(11, NAU83110_RCHA_SFT)
#define NAU83110_RCHA_CH7		(0x7 << NAU83110_RCHA_SFT)
#define NAU83110_RCHA_CH5		(0x5 << NAU83110_RCHA_SFT)
#define NAU83110_RCHA_CH3		(0x3 << NAU83110_RCHA_SFT)
#define NAU83110_RCHA_CH1		(0x1 << NAU83110_RCHA_SFT)
#define NAU83110_LCHA_SFT		6
#define NAU83110_LCHA_MASK		GENMASK(8, NAU83110_LCHA_SFT)
#define NAU83110_LCHA_CH6		(0x6 << NAU83110_LCHA_SFT)
#define NAU83110_LCHA_CH4		(0x4 << NAU83110_LCHA_SFT)
#define NAU83110_LCHA_CH2		(0x2 << NAU83110_LCHA_SFT)
#define NAU83110_LCHA_CH0		(0x0 << NAU83110_LCHA_SFT)
#define NAU83110_LRP0_SFT		4
#define NAU83110_LRP0_MASK		GENMASK(4, NAU83110_LRP0_SFT)
#define NAU83110_LRP0_PCMB		(0x1 << NAU83110_LRP0_SFT)
#define NAU83110_LRP0_PCMA		(0x0 << NAU83110_LRP0_SFT)
#define NAU83110_WLEN_SFT		2
#define NAU83110_WLEN_MASK		GENMASK(3, NAU83110_WLEN_SFT)
#define NAU83110_WLEN_32		(0x3 << NAU83110_WLEN_SFT)
#define NAU83110_WLEN_24		(0x2 << NAU83110_WLEN_SFT)
#define NAU83110_WLEN_20		(0x1 << NAU83110_WLEN_SFT)
#define NAU83110_WLEN_16		(0x0 << NAU83110_WLEN_SFT)
#define NAU83110_AIFMT_MASK		GENMASK(1, 0)
#define NAU83110_AIFMT_PCM		0x3
#define NAU83110_AIFMT_I2S		0x2
#define NAU83110_AIFMT_LJ		0x1
#define NAU83110_AIFMT_RJ		0x0

/* NAU83110_R7D_TDM_RX_CTRL1 (0x7D) */
#define NAU83110_BCLK_INV_SFT		4
#define NAU83110_BCLK_INV		(0x1 << NAU83110_BCLK_INV_SFT)
#define NAU83110_TDM_CH_SEL_MASK	GENMASK(3, 0)
#define NAU83110_TDM_CH_SEL_SLOT45	0xc
#define NAU83110_TDM_CH_SEL_SLOT01	0xb
#define NAU83110_TDM_CH_SEL_SLOT7	0xa
#define NAU83110_TDM_CH_SEL_SLOT6	0x9
#define NAU83110_TDM_CH_SEL_SLOT5	0x8
#define NAU83110_TDM_CH_SEL_SLOT4	0x7
#define NAU83110_TDM_CH_SEL_SLOT3	0x6
#define NAU83110_TDM_CH_SEL_SLOT2	0x5
#define NAU83110_TDM_CH_SEL_SLOT1	0x4
#define NAU83110_TDM_CH_SEL_SLOT0	0x3

/* NAU83110_RA8_STANDBY_CTRL (0xA8) */
#define NAU83110_STANDBY_CTRL_SFT	12
#define NAU83110_STANDBY_CTRL_MASK	GENMASK(15, NAU83110_STANDBY_CTRL_SFT)
#define NAU83110_STANDBY_CTRL		(0xf << NAU83110_STANDBY_CTRL_SFT)
#define NAU83110_EFUASE_SFT		4
#define NAU83110_EFUASE_READ_MASK	GENMASK(7, NAU83110_EFUASE_SFT)
#define NAU83110_EFUASE_READ		(0xa << NAU83110_EFUASE_SFT)

/* NAU83110_RBD_PWRSTAGE_CTRL2 (0xBD) */
#define NAU83110_HVDRIVER_CTRL2_SFT	12
#define NAU83110_HVDRIVER_CTRL2		(0x1 << NAU83110_HVDRIVER_CTRL2_SFT)
#define NAU83110_DEBONS_MASK		GENMASK(2, 0)

enum {
	DIAG_SUCCESS,
	DIAG_FAIL,
};

struct nau83110 {
	struct device *dev;
	struct regmap *regmap;
	struct gpio_desc *enable_pin;
	struct mutex lock;
	struct delayed_work diag_work;
	struct work_struct trigger_work;
	struct workqueue_struct *wq;
	bool irq_enabled;
	int delayed_time;
	int diag_status;
	int work_cmd;
	int irq;
};

#endif /* __NAU83110_H__ */